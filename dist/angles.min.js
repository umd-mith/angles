/*! angles 2013-11-12 */
!function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};window.Angles={},function(a,c,d,e){var f,g,h,i,j,k,l,m,n,o;return f=null,a.XMLDocument=function(a){function c(){return g=c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.defaults={name:"untitled",content:""},c.prototype.validate=function(){},c}(d.Model),a.XMLDocumentList=function(c){function d(){return h=d.__super__.constructor.apply(this,arguments)}return b(d,c),d.prototype.model=a.XMLDocument,d}(d.Collection),a.Notification=function(a){function c(){return i=c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.defaults={type:"",info:"",message:"",resource:"",location:{column:-1,row:-1}},c}(d.Model),a.NotificationList=function(c){function d(){return j=d.__super__.constructor.apply(this,arguments)}return b(d,c),d.prototype.model=a.Notification,d}(d.Collection),a.FileSelector=function(d){function e(){return k=e.__super__.constructor.apply(this,arguments)}return b(e,d),e.prototype.initialize=function(){return this.template=c.template($("#file-list-template").html())},e.prototype.render=function(){return this.$el.html(this.template({})),this.collection.each(this.addOne,this),this},e.prototype.addOne=function(b){var c;return c=new a.FileSelectorRow({model:b}),this.$("form").append(c.render().$el)},e}(d.View),a.FileSelectorRow=function(a){function d(){return l=d.__super__.constructor.apply(this,arguments)}return b(d,a),d.prototype.initialize=function(){return this.template=c.template($("#file-item-template").html()),this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},d.prototype.render=function(){return this.$el.html(this.template(this.model.toJSON())),this},d}(d.View),a.NotificationTable=function(d){function e(){return m=e.__super__.constructor.apply(this,arguments)}return b(e,d),e.prototype.initialize=function(){return this.template=c.template($("#notification-list-template").html())},e.prototype.render=function(){return this.$el.html(this.template({})),this.listenTo(this.collection,"add",this.addOne),this},e.prototype.addOne=function(b){var c;return c=new a.NotificationRow({model:b}),this.$(".notifications").append(c.render().$el)},e}(d.View),a.NotificationRow=function(a){function d(){return n=d.__super__.constructor.apply(this,arguments)}return b(d,a),d.prototype.initialize=function(){return this.template=c.template($("#notification-template").html()),this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},d.prototype.render=function(){return this.$el.html(this.template(this.model.toJSON())),this},d}(d.View),a.ACEEditorView=function(a){function f(){return o=f.__super__.constructor.apply(this,arguments)}return b(f,a),f.prototype.tagName="div",f.prototype.className="ace-editor",f.prototype.initialize=function(){var a,b,e=this;return a=[],b=this.options.dispatcher||c.clone(d.Events),this.dispatcher=b,b.on("editor:reload",function(){return e.clearAnnotations(),e.setContent()}),b.on("document:save",function(){return e.saveModel()}),b.on("validation:start",function(){return a=[],e.dispatcher.trigger("notification:clear")}),b.on("validation:error",function(b){var c;return a.push(b),c={type:"validation",info:b.type,message:b.text,location:{row:b.row,column:b.column}},e.dispatcher.trigger("notification:push",c)}),b.on("validation:end",function(){var b;return b=e.$editor.getSelection(),e.clearAnnotations(),e.$editor.focus(),a.length>0&&(e.$editor.gotoLine(a[0].row+1,a[0].column,!0),b.selectWordLeft(),b.selectWordLeft()),e.$editor.session.setAnnotations(a)}),b.on("document:switch",function(a){return e.setModel(a)})},f.prototype.render=function(){var a=this;return this.$editor=e.edit(this.el),this.$editor.getSession().on("change",function(b){return a.dispatcher.trigger("editor:change",b)}),this.$editor.getSession().setMode("ace/mode/xml"),e.config.set("basePath","../deps/"),e.config.loadModule("ext/angles",function(){var b;return a.$editor.setOptions({enableODDAutocompletion:!0}),b={getCompletions:function(b,c,d,e,f){var g,h,i,j,k,l,m,n;if(null==a.$context)return 0;if(j=a.$context,l=function(a,c){var d,e,f,g,h,i;return h=[],d=[],g=!1,f=!1,e="",i=function(a,c){var j,k,l,m,n,o,p;for(j=0,m=b.getSession().getTokens(a),n=0,o=m.length;o>n;n++)l=m[n],j+=l.value.length,j>c&&("meta.tag.punctuation.begin"===l.type&&"<"===l.value?g=!0:"meta.tag.punctuation.begin"===l.type&&"</"===l.value?f=!0:"meta.tag.punctuation.end"===l.type&&"/>"===l.value?(h.pop(),g=!1,f=!1):"meta.tag.name"===l.type&&g?(h.push(l.value),g=!1):"meta.tag.name"===l.type&&f&&(d.push(l.value),f=!1));if(0===d.length)return i(a+1,0);if(1===d.length&&0===h.length)return e=d[d.length-1];for(k=h.length,p=[];k--;)d[d.length-1]===h[k]?(h.splice(k),d.pop(),p.push(i(a+1,0))):p.push(e=d[d.length-1]);return p},i(a,c),e},d=b.getCursorPosition(),k=l(d.row,d.column),i=[],h=j.getChildrenOf(k),null!=h)for(m=0,n=h.length;n>m;m++)g=h[m],i.push({caption:g.ident,snippet:""+g.ident+"></"+g.ident+">",meta:"element"});else i.push({caption:"unknown parent",snippet:"",meta:"element"});return i.length>0?f(null,i):void 0}},a.$editor.completers=[b],e.config.on("desc",function(b){return a.dispatcher.trigger("editor:context",b.ident)}),e.config.on("desc:clear",function(){return a.dispatcher.trigger("notification:clear")})}),this},f.prototype.setContent=function(){return this.$editor.setValue(this.model.get("content"))},f.prototype.getContent=function(){return this.$editor.getValue()},f.prototype.getDocument=function(){var a=this;return{getValue:function(){return a.$editor.getValue()},getLength:function(){return a.$editor.session.getDocument().getLength()},getLine:function(b){return a.$editor.session.getDocument().getLine(b)}}},f.prototype.saveModel=function(){var a=this;return this.model.set("content",this.getContent()),this.model.save({success:function(){return a.dispatcher.trigger("editor:reload")},error:function(){return a.dispatcher.trigger("editor:error","Unable to change document")}})},f.prototype.setModel=function(a){return this.model=a,this.dispatcher.trigger("editor:reload")},f.prototype.clearAnnotations=function(){return this.$editor.session.clearAnnotations()},f.prototype.setMode=function(a){return this.$editor.getSession().setMode(a)},f}(d.View)}(window.Angles,_,Backbone,ace)}.call(this),function(){Angles.ContextHelp=function(){function a(a){var b;b=this.dispatcher=a.dispatcher,this.$odd={},this.$angles=a.anglesView}return a.prototype.setODD=function(a){return this.$odd=a},a.prototype.getODDfor=function(a){var b,c,d,e;for(b=this.$odd.members,d=0,e=b.length;e>d;d++)if(c=b[d],c.ident===a)return c;return null},a.prototype.getDescOf=function(a){var b;return null!=(b=this.getODDfor(a))?b.desc:void 0},a.prototype.getChildrenOf=function(a){var b;return null!=(b=this.getODDfor(a))?b.children:void 0},a}()}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};Angles.FileUploader=function(){function b(b){this._handleFileSelect=a(this._handleFileSelect,this);var c;c=this.dispatcher=b.dispatcher,this.$angles=b.anglesView,this.storedFiles=b.storedFiles}return b.prototype._handleFileSelect=function(a){var b,c,d=this;return b=a.target.files[0],c=new FileReader,c.onload=function(a){var c,e;return e=d.storedFiles.find(function(a){return a.get("name")===b.name}),null!=e&&e.destroy(),c=d.storedFiles.create({name:b.name,content:a.target.result}),d.dispatcher.trigger("document:switch",c)},c.readAsText(b,"UTF-8")},b.prototype.bind=function(a){return $(a).change(this._handleFileSelect)},b}()}.call(this),function(){Angles.NotificationCenter=function(){function a(a){var b,c=this;b=this.dispatcher=a.dispatcher,this.$angles=a.anglesView,this.$notifications=new Angles.NotificationList,b.on("notification:push",function(a){return c.push(a)}),b.on("notification:clear",function(){return c.clear()})}return a.prototype.push=function(a){return this.$notifications.add(a)},a.prototype.clear=function(){for(var a;a=this.$notifications.first();)a.destroy();return null},a}()}.call(this),function(){Angles.Validator=function(){function a(a){var b;b=this.dispatcher=a.dispatcher,this.$schema={},this.$errors=[],this.$angles=a.anglesView}return a.prototype.displayErrors=function(){var a,b,c,d;for(d=this.errors(),b=0,c=d.length;c>b;b++)a=d[b],this.dispatcher.trigger("validation:error",a);return this.endValidation()},a.prototype.addError=function(a){return this.$errors.push(a)},a.prototype.clearErrors=function(){return this.$errors=[]},a.prototype.endValidation=function(){return this.dispatcher.trigger("validation:end")},a.prototype.setSchema=function(a){return this.$schema=a,this.dispatcher.trigger("validation")},a.prototype.errors=function(){return this.$errors},a.prototype.hasErrors=function(){return 0!==this.$errors.length},a}()}.call(this),function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b},c=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};Angles.SAXParser=function(){function a(a){this.reset=function(){var b,c=this;return b=sax.parser(!0,{xmlns:!0,noscript:!0,position:!0}),b.onerror=null!=a.error?function(d){return a.error.call(c,d),b.resume()}:function(a){return c.validationError(a.message.split(/\n/)[0]+"."),b.resume()},null!=a.characters&&(b.ontext=function(b){return a.characters.call(c,b)}),null!=a.startElement&&(b.onopentag=function(b){return a.startElement.call(c,b)}),null!=a.endElement&&(b.onclosetag=function(b){return a.endElement.call(c,b)}),null!=a.comment&&(b.oncomment=function(b){return a.comment.call(c,b)}),null!=a.startCdata&&(b.onopencdata=function(){return a.startCdata.call(c)}),null!=a.cdata&&(b.oncdata=function(b){return a.cdata.call(c,b)}),null!=a.endCdata&&(b.onclosecdata=function(){return a.endCdata.call(c)}),null!=a.endDocument&&(b.onend=function(){return a.endDocument.call(c)}),b.onstart=null!=a.startDocument?function(){return a.startDocument.call(c)}:function(){},this.$parser=b,this.$errors=[]}}return a.prototype.parse=function(a){var b,c,d,e;for(this.reset(),d=this.$parser,c=a.getLength(),d.onstart(),b=e=0;c>=0?c>=e:e>=c;b=c>=0?++e:--e)d.write(a.getLine(b)+"\n");return d.close(),this.validated()?!0:!1},a.prototype.validationError=function(a,b){var c;return c=this.$parser,this.$errors.push({text:a,row:c.line,column:c.column,type:null!=b?b:"error"})},a.prototype.validated=function(){return 0===this.$errors.length},a}(),Angles.ValidatorSAX=function(a){function d(a){var b=this;d.__super__.constructor.call(this,a),this.dispatcher.on("validation",function(){var a,c;return a=null!=(c=b.$angles)?c.getDocument():void 0,null!=a?(b.dispatcher.trigger("validation:start"),b.validate(b.$angles.getDocument())):void 0})}return b(d,a),d.prototype.checkSchema=function(a,b){var d,e,f,g,h;if(null!=this.$schema)return 1===(null!=b?b.length:void 0)?(this.$schema.hasOwnProperty(null!=(g=b[0])?g.name:void 0)?(f=new RegExp(this.$schema._start,"ig"),null===f.exec(b[0].name+",")&&a.validationError("Invalid root element: "+b[0].name+".")):a.validationError("Invalid root element: "+b[0].name+"."),void 0):(d=b[0].name,e=b[1].name,null==this.$schema[e]?a.validationError("The "+d+" element is not allowed as a child of the "+e+" element."):(c.call(null!=(h=this.$schema[e])?h.children:void 0,d)<0&&a.validationError("The "+d+" element is not allowed as a child of the "+e+" element."),void 0))},d.prototype.checkChildren=function(a,b){var c,d,e;if(null!=this.$schema&&b.length>0&&(d=b[0],c=d.children.join(","),""!==c&&(c+=","),this.$schema.hasOwnProperty(null!=d?d.name:void 0)&&this.$schema[d.name].hasOwnProperty("model")))return e=new RegExp(this.$schema[d.name].model,"ig"),null===e.exec(c)?a.validationError(d.name+" is invalid: one or more required children are missing or its child elements are in the wrong order."):void 0},d.prototype.validate=function(a){var b,c,d=this;return b=[],c=new Angles.SAXParser({startDocument:function(){return b=[]},endDocument:function(){var a,d;return b.length>0?(d=function(){var c,d,e;for(e=[],c=0,d=b.length;d>c;c++)a=b[c],e.push(a.name);return e}(),c.validationError("Unclosed elements at end of document: "+d.join(", "))):void 0},startElement:function(a){return b.length>0&&b[0].children.push(a.local),b.unshift({name:a.local,children:[]}),d.checkSchema(c,b)},characters:function(a){return b.length>0&&null===a.match(/^[\s\r\n]*$/)?b[0].children.push("_text_"):void 0},endElement:function(){return d.checkChildren(c,b),b.shift()}}),c.parse(a),this.$errors=c.$errors,this.displayErrors()},d}(Angles.Validator)}.call(this),function(){var a={}.hasOwnProperty,b=function(b,c){function d(){this.constructor=b}for(var e in c)a.call(c,e)&&(b[e]=c[e]);return d.prototype=c.prototype,b.prototype=new d,b.__super__=c.prototype,b};Angles.ValidatorSRV=function(a){function c(a){var b=this;c.__super__.constructor.call(this,a),this.$validatorUrl=a.validator,this.$requestHandler=null!=a.requestHandler?a.requestHandler:d,this.$validationHandler=null!=a.validationHandler?a.validationHandler:e,this.dispatcher.on("validation",function(){return b.dispatcher.trigger("validation:start"),b.$requestHandler(b)})}var d,e;return b(c,a),d=function(a){var b,c,d=this;return b=a.$angles.getDocument(),c=escape(b.getValue()),$.ajax({url:a.$validatorUrl,type:"POST",crossDomain:!0,processData:!1,data:"schema="+a.$schema+"&document="+c,dataType:"json",success:function(b){return a.$validationHandler(a,b)},error:function(a,b,c){var e;return d.dispatcher.trigger("notification:clear"),c=0===a.status?"Cannot reach server":c,e={type:"Server",info:"Status: "+a.status,message:c,location:{row:-1,column:-1}},d.dispatcher.trigger("notification:push",e)}})},e=function(a,b){var c,d,e;for(a.$errors=[],d=0,e=b.length;e>d;d++)c=b[d],a.$errors.push({text:c.message,row:c.line-1,column:c.column,type:c.type});return a.displayErrors()},c}(Angles.Validator)}.call(this);